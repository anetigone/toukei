# Toukei 项目信息文档

## 项目概述

**Toukei** 是一个用 Rust 编写的代码统计工具，目前处于开发阶段（版本 0.1.0）。该项目旨在统计代码库中各种编程语言的代码行数、注释行数、空行数等指标。

## 技术栈

### 编程语言
- Rust (Edition 2024)

### 依赖项
- `serde` (1.0.220) - 序列化/反序列化，启用 derive 特性
- `serde_json` (1.0.141) - JSON 支持
- `walkdir` (2.3.2) - 目录遍历
- `regex` (1.9.1) - 正则表达式支持
- `rayon` (1.8.1) - 并行计算
- `lazy_static` (1.4.0) - 延迟静态初始化
- `strum` (0.27) - 枚举工具
- `strum_macros` (0.27) - 枚举宏

## 项目结构

```
toukei/
├── src/
│   ├── main.rs              # 主入口（已实现）
│   ├── lib.rs               # 库模块导出
│   ├── cli.rs               # 命令行接口（基础框架）
│   ├── config.rs            # 配置管理（已实现）
│   ├── stats.rs             # 统计数据结构（已实现）
│   ├── walker.rs            # 文件遍历器（已实现）
│   ├── report.rs            # 报告生成（已实现）
│   ├── ffi.rs               # 外部函数接口（未实现）
│   ├── consts.rs            # 常量定义（未实现）
│   ├── langs/               # 语言支持模块（已实现）
│   │   ├── mod.rs
│   │   ├── definitions.rs   # 语言定义（已实现）
│   │   ├── lang_def.rs      # 语言定义结构
│   │   ├── lang_err.rs      # 语言错误处理
│   │   ├── lang_type.rs     # 语言类型枚举（已实现）
│   │   └── registry.rs      # 语言注册表（已实现）
│   ├── parser/              # 参数解析模块（已实现）
│   │   ├── mod.rs
│   │   ├── arg.rs           # 参数定义
│   │   ├── args_parser.rs   # 参数解析器
│   │   ├── value_parser.rs  # 值解析器
│   │   ├── parse_error.rs   # 解析错误
│   │   ├── matches.rs       # 匹配器
│   │   ├── any_value.rs     # 任意值类型
│   │   └── arg_cursor.rs    # 参数游标
│   ├── syntax/              # 语法分析模块（部分实现）
│   │   ├── mod.rs           # 语法模块（已实现）
│   │   ├── lex_status.rs    # 词法分析状态
│   │   ├── lexer.rs         # 词法分析器
│   │   ├── classifier.rs    # 分类器
│   │   └── lex_error.rs     # 词法分析错误
│   ├── utils/               # 工具模块
│   │   ├── mod.rs
│   │   └── format.rs        # 格式化工具（未实现）
│   └── macros/              # 宏模块
│       └── mod.rs           # 宏定义（未实现）
├── Cargo.toml               # 项目配置
├── README.md               # 项目说明（空）
└── target/                 # 编译输出目录
```

## 核心功能模块

### 0. 异步文件计数器 (`fc.rs`)
新增了异步版本的文件计数器 `AsyncFileCounter`，实现了生产者-消费者模式：

**特性**：
- **异步并行处理**：使用 tokio 异步运行时，支持并发处理多个文件
- **生产者-消费者架构**：
  - 多个生产者同时遍历不同目录
  - 使用信号量控制的消费者池处理文件
  - 通过 mpsc 通道传递文件路径
- **可配置工作线程数**：
  - 默认使用 CPU 核心数
  - 可通过环境变量 `TOUKEI_WORKERS` 设置
  - 支持运行时通过 `with_workers()` 方法设置
- **流式处理**：边遍历目录边处理文件，减少内存占用
- **保留原有代码**：`FileCounter` 保持不变，向后兼容

**性能对比**：
- 在测试中，异步版本比同步版本快约 25 倍
- 特别适合大型代码库的统计

### 1. 配置管理 (`config.rs`)
- 定义了 `Config` 结构体，包含：
  - `paths`: 要扫描的路径列表
  - `types`: 要统计的文件类型
  - `ignore_blanks`: 是否忽略空行
  - `ignore_comments`: 是否忽略注释
  - `exclude_files`: 排除的文件列表
  - `show_stats`: 是否显示统计信息
  - `output`: 输出格式（文本/JSON等）
  - `help`: 是否显示帮助信息

### 2. 统计数据 (`stats.rs`)
- `FileStat`: 单文件统计信息
  - 路径、名称、大小
  - 行数、代码行数、注释行数、空行数
  - 函数数量、类数量
- `LangStat`: 语言级别统计
  - 文件数量、各类行数统计
  - 支持多个统计结果的合并

### 3. 语言支持 (`langs/registry.rs` & `definitions.rs`)
支持 **58 种编程语言和标记语言**：

#### 主流编程语言
- **Rust** - `.rs` 文件
- **Python** - `.py` 文件
- **JavaScript** - `.js` 文件
- **TypeScript** - `.ts` 文件
- **Go** - `.go` 文件
- **Java** - `.java` 文件
- **C++** - `.cpp`, `.cxx`, `.cc`, `.c++`, `.hpp`, `.hxx`, `.hh`, `.h++` 文件
- **C** - `.c`, `.h` 文件
- **C#** - `.cs` 文件
- **Swift** - `.swift` 文件
- **Kotlin** - `.kt` 文件
- **Dart** - `.dart` 文件
- **PHP** - `.php` 文件

#### 函数式和专用语言
- **Haskell** - `.hs` 文件
- **Clojure** - `.clj`, `.cljs`, `.cljc`, `.edn` 文件
- **F#** - `.fs` 文件
- **OCaml** - `.ml` 文件
- **Scala** - `.scala` 文件
- **Erlang** - `.erl` 文件
- **R** - `.r` 文件
- **Julia** - `.jl` 文件
- **Ruby** - `.rb` 文件
- **Lua** - `.lua` 文件
- **Perl** - `.pl` 文件
- **Tcl** - `.tcl` 文件
- **Zig** - `.zig` 文件
- **D** - `.d` 文件
- **V** - `.v` 文件
- **Elm** - `.elm` 文件

#### 脚本和配置语言
- **Shell** - `.sh`, `.bash` 文件
- **Nix** - `.nix` 文件
- **SQL** - `.sql` 文件

#### 量子计算语言
- **QCL** - `.qcl` 文件
- **Q#** - `.qs` 文件

#### 现代Web技术
- **Astro** - `.astro` 文件
- **Sass** - `.sass`, `.scss` 文件
- **GraphQL** - `.graphql`, `.gql` 文件
- **Jsonnet** - `.jsonnet` 文件

#### 文档和标记语言
- **Markdown** - `.md`, `.markdown` 文件
- **HTML** - `.html`, `.htm` 文件
- **CSS** - `.css` 文件
- **AsciiDoc** - `.adoc`, `.asciidoc`, `.asc` 文件
- **TeX** - `.tex`, `.latex` 文件

#### 数据格式
- **JSON** - `.json` 文件
- **YAML** - `.yaml`, `.yml` 文件
- **TOML** - `.toml` 文件
- **XML** - `.xml` 文件
- **Regex** - `.regex`, `.re` 文件

#### 文本和其他
- **Text** - `.txt` 文件
- **文言** - `.wenyan`, `.wy` 文件

每种语言定义包括：
- 文件扩展名
- 单行注释符号
- 块注释符号对
- 文档注释符号
- 函数匹配模式（正则表达式）
- 类/结构体匹配模式

### 4. 参数解析 (`parser/`)
- 支持复杂的命令行参数解析
- 类型安全的值解析
- 自定义解析器支持
- 错误处理机制

### 5. 语法分析 (`syntax/`)
- 定义了 `Syntax` trait 用于不同语言的语法分析
- `GeneralSyntax` 实现通用语法分析
- 支持逐行分析代码结构

## 项目状态

### 已完成模块
- ✅ 项目结构搭建
- ✅ 基础数据结构定义
- ✅ 语言定义和注册表
- ✅ 参数解析框架
- ✅ 配置管理系统
- ✅ 文件遍历器（已实现）
- ✅ 报告生成模块（已实现）
- ✅ 主程序入口（已实现）

### 进行中模块

- 🚧 语法分析器（部分实现）
- 🚧 命令行接口（基础框架）

### 未实现模块

- ❌ 宏定义
- ❌ 常量定义
- ❌ FFI 接口
- ❌ 格式化工具

## 特性设计

### 并行处理
- 使用 `rayon` 支持并行文件处理
- 提高大代码库的统计性能

### 灵活配置
- 支持多种输出格式
- 可配置忽略规则
- 支持自定义文件类型过滤

### 可扩展性
- 模块化设计，易于添加新语言支持
- 基于 trait 的语法分析器
- 可插拔的解析器系统

## 开发建议

1. **优先完成核心功能**：
   - 实现主程序入口
   - 完成文件遍历器
   - 实现基本的语法分析

2. **完善测试覆盖**：
   - 为各模块添加单元测试
   - 添加集成测试
   - 性能测试

3. **文档完善**：
   - 完善 README.md
   - 添加使用示例
   - API 文档

4. **错误处理**：
   - 完善错误处理机制
   - 提供用户友好的错误信息

## 潜在改进方向

1. **性能优化**：
   - 大文件处理优化
   - 内存使用优化
   - 缓存机制

2. **功能扩展**：
   - 代码复杂度分析
   - 代码质量指标
   - 历史趋势分析

3. **用户体验**：
   - 进度显示
   - 彩色输出
   - 交互式配置

## TODO 清单

请根据项目的实际需求填写以下 TODO 事项：

| 优先级 | 任务模块 | 任务描述 | 负责人 | 状态 | 截止日期 |
|--------|----------|----------|--------|------|----------|
|   1     |   syntax       |      pythonLexer,MdLexer,函数式语言的,还有乱七八糟的的    |    1    |   进行中   |     na     |
|    2    |          |    rayon并行处理      |        |  完成    |          |
|    3    |          |     结果统计与输出（文件）     |        |      |          |
|    4    |          |     read会把文件转为UTF-8编码，有大量内存分配操作     |        |      |          |
|    5    |          |     语言注册很繁琐，考虑简化方案     |        |      |          |
|    6    |          |     参数检查     |        |      |          |
|    7    |          |     保存为文件     |        |      |          |
|    8    |          |     ffi     |        |      |          |

### 优先级说明
- 🔴 高：关键功能，阻塞其他模块
- 🟡 中：重要功能，影响用户体验
- 🟢 低：增强功能，可后续添加

### 状态说明
- 未开始
- 进行中
- 已完成
- 阻塞
- 取消

---

*最后更新：2025-12-13*